services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: creatorx_postgres
    environment:
      POSTGRES_USER: creatorx
      POSTGRES_PASSWORD: creatorx_password
      POSTGRES_DB: creatorx
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U creatorx"]
      interval: 10s
      timeout: 5s
      retries: 5

  # # ClickHouse Vector Database
  # clickhouse:
  #   image: clickhouse/clickhouse-server:latest
  #   container_name: creatorx_clickhouse
  #   environment:
  #     CLICKHOUSE_DB: creatorx
  #     CLICKHOUSE_USER: creatorx
  #     CLICKHOUSE_PASSWORD: creatorx_password
  #   ports:
  #     - "8123:8123"
  #     - "9000:9000"
  #   volumes:
  #     - clickhouse_data:/var/lib/clickhouse
  #   healthcheck:
  #     test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # # Redis Cache
  # redis:
  #   image: redis:7-alpine
  #   container_name: creatorx_redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: creatorx_backend
    env_file:
      - .env
    environment:
      # Database URLs (override for Docker networking)
      DATABASE_URL: postgresql://creatorx:creatorx_password@postgres:5432/creatorx
      CLICKHOUSE_URL: http://clickhouse:8123
      REDIS_URL: redis://redis:6379

      # Pass through all env vars from .env file
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GOOGLE_VERTEX_PROJECT_ID: ${GOOGLE_VERTEX_PROJECT_ID:-}
      GOOGLE_VERTEX_LOCATION: ${GOOGLE_VERTEX_LOCATION:-}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/app/Vertex_AI_Creds.json}
      GROQ_API_KEY: ${GROQ_API_KEY}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID:-}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET:-}
      RAZORPAY_WEBHOOK_SECRET: ${RAZORPAY_WEBHOOK_SECRET:-}
      RAZORPAY_MODE: ${RAZORPAY_MODE:-test}
      APP_NAME: ${APP_NAME:-CreatorX}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      DEBUG: ${DEBUG:-False}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      ALLOW_NGROK: ${ALLOW_NGROK:-False}
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./backend/Vertex_AI_Creds.json:/app/Vertex_AI_Creds.json:ro
    depends_on:
      postgres:
        condition: service_healthy
      # redis:
      #   condition: service_healthy
      # clickhouse:
      #   condition: service_healthy
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Celery Worker for async tasks
  # celery_worker:
  #   build:
  #     context: ./backend
  #     dockerfile: Dockerfile
  #   container_name: creatorx_celery
  #   environment:
  #     DATABASE_URL: postgresql://creatorx:creatorx_password@postgres:5432/creatorx
  #     CLICKHOUSE_URL: http://clickhouse:8123
  #     REDIS_URL: redis://redis:6379
  #     OPENAI_API_KEY: ${OPENAI_API_KEY}
  #     GOOGLE_VERTEX_PROJECT_ID: ${GOOGLE_VERTEX_PROJECT_ID}
  #     GROQ_API_KEY: ${GROQ_API_KEY}
  #   volumes:
  #     - ./backend:/app
  #   depends_on:
  #     - redis
  #     - postgres
  #   command: celery -A app.celery_worker worker --loglevel=info

  # React Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: creatorx_frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - backend

volumes:
  postgres_data:
  # clickhouse_data:
  # redis_data:
